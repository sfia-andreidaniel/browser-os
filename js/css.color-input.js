window.CSSDefs = window.CSSDefs || {}; window.CSSDefs.colors = {    

"aliceblue"         : "#F0F8FF",     "antiquewhite"      : "#FAEBD7",    
"aqua"              : "#00FFFF",     "aquamarine"        : "#7FFFD4",    
"azure"             : "#F0FFFF",     "beige"             : "#F5F5DC",    
"bisque"            : "#FFE4C4",     "black"             : "#000000",    
"blanchedalmond"    : "#FFEBCD",     "blue"              : "#0000FF",    
"blueviolet"        : "#8A2BE2",     "brown"             : "#A52A2A",    
"burlywood"         : "#DEB887",     "cadetblue"         : "#5F9EA0",    
"chartreuse"        : "#7FFF00",     "chocolate"         : "#D2691E",    
"coral"             : "#FF7F50",     "cornflowerblue"    : "#6495ED",    
"cornsilk"          : "#FFF8DC",     "crimson"           : "#DC143C",    
"cyan"              : "#00FFFF",     "darkblue"          : "#00008B",    
"darkcyan"          : "#008B8B",     "carkgoldenrod"     : "#B8860B",    
"darkgray"          : "#A9A9A9",     "darkgreen"         : "#006400",    
"darkkhaki"         : "#BDB76B",     "darkmagenta"       : "#8B008B",    
"darkolivegreen"    : "#556B2F",     "darkorange"        : "#FF8C00",    
"darkorchid"        : "#9932CC",     "darkred"           : "#8B0000",    
"darksalmon"        : "#E9967A",     "darkseagreen"      : "#8FBC8F",    
"darkslateblue"     : "#483D8B",     "darkslategray"     : "#2F4F4F",    
"darkturquoise"     : "#00CED1",     "darkviolet"        : "#9400D3",    
"deeppink"          : "#FF1493",     "deepskyblue"       : "#00BFFF",    
"dimgray"           : "#696969",     "dimgrey"           : "#696969",    
"dodgerblue"        : "#1E90FF",     "firebrick"         : "#B22222",    
"floralwhite"       : "#FFFAF0",     "forestgreen"       : "#228B22",    
"fuchsia"           : "#FF00FF",     "gainsboro"         : "#DCDCDC",    
"ghostwhite"        : "#F8F8FF",     "gold"              : "#FFD700",    
"goldenrod"         : "#DAA520",     "gray"              : "#808080",    
"green"             : "#008000",     "greenyellow"       : "#ADFF2F",    
"honeydew"          : "#F0FFF0",     "hotpink"           : "#FF69B4",    
"indianred"         : "#CD5C5C",     "indigo"            : "#4B0082",    
"ivory"             : "#FFFFF0",     "khaki"             : "#F0E68C",    
"lavender"          : "#E6E6FA",     "lavenderblush"     : "#FFF0F5",    
"lawngreen"         : "#7CFC00",     "lemonchiffon"      : "#FFFACD",    
"lightblue"         : "#ADD8E6",     "lightcoral"        : "#F08080",    
"lightcyan"         : "#E0FFFF",     "lightgoldenrodyellow": "#FAFAD2",    
"lightgray"         : "#D3D3D3",     "lightgreen"        : "#90EE90",    
"lightpink"         : "#FFB6C1",     "lightsalmon"       : "#FFA07A",    
"lightseagreen"     : "#20B2AA",     "lightskyblue"      : "#87CEFA",    
"lightslategray"    : "#778899",     "lightsteelblue"    : "#B0C4DE",    
"lightyellow"       : "#FFFFE0",     "lime"              : "#00FF00",    
"limegreen"         : "#32CD32",     "linen"             : "#FAF0E6",    
"magenta"           : "#FF00FF",     "maroon"            : "#800000",    
"mediumaquamarine"  : "#66CDAA",     "mediumblue"        : "#0000CD",    
"mediumorchid"      : "#BA55D3",     "mediumpurple"      : "#9370DB",    
"mediumseagreen"    : "#3CB371",     "mediumslateblue"   : "#7B68EE",    
"mediumspringgreen" : "#00FA9A",     "mediumturquoise"   : "#48D1CC",    
"mediumvioletred"   : "#C71585",     "midnightblue"      : "#191970",    
"mintcream"         : "#F5FFFA",     "mistyrose"         : "#FFE4E1",    
"moccasin"          : "#FFE4B5",     "navajowhite"       : "#FFDEAD",    
"navy"              : "#000080",     "oldlace"           : "#FDF5E6",    
"olive"             : "#808000",     "olivedrab"         : "#6B8E23",    
"orange"            : "#FFA500",     "orangered"         : "#FF4500",    
"orchid"            : "#DA70D6",     "palegoldenrod"     : "#EEE8AA",    
"palegreen"         : "#98FB98",     "paleturquoise"     : "#AFEEEE",    
"palevioletred"     : "#DB7093",     "papayawhip"        : "#FFEFD5",    
"peachpuff"         : "#FFDAB9",     "peru"              : "#CD853F",    
"pink"              : "#FFC0CB",     "plum"              : "#DDA0DD",    
"powderblue"        : "#B0E0E6",     "purple"            : "#800080",    
"red"               : "#FF0000",     "rosybrown"         : "#BC8F8F",    
"royalblue"         : "#4169E1",     "saddlebrown"       : "#8B4513",    
"salmon"            : "#FA8072",     "sandybrown"        : "#F4A460",    
"seagreen"          : "#2E8B57",     "seashell"          : "#FFF5EE",    
"sienna"            : "#A0522D",     "silver"            : "#C0C0C0",    
"skyblue"           : "#87CEEB",     "slateblue"         : "#6A5ACD",    
"slategray"         : "#708090",     "snow"              : "#FFFAFA",    
"springgreen"       : "#00FF7F",     "steelblue"         : "#4682B4",    
"tan"               : "#D2B48C",     "teal"              : "#008080",    
"thistle"           : "#D8BFD8",     "tomato"            : "#FF6347",    
"turquoise"         : "#40E0D0",     "violet"            : "#EE82EE",    
"wheat"             : "#F5DEB3",     "white"             : "#FFFFFF",    
"whitesmoke"        : "#F5F5F5",     "yellow"            : "#FFFF00",    
"yellowgreen"       : "#9ACD32" 

};

function CSSColorStruc( colObj ) {
    var c = null;
    ( colObj || {} ).chain( function(){ 
        if ( this.r >= 0 && this.r <= 255 &&
             this.g >= 0 && this.g <= 255 &&
             this.b >= 0 && this.b <= 255 &&
             this.a >= 0 && this.a <= 1
        ) {
            c = {
                "r": this.r,
                "g": this.g,
                "b": this.b,
                "a": this.a
            }.chain( function() {
                Object.defineProperty( this, "rgbValue", {
                    "get": function() {
                        return {
                            "r": this.r,
                            "g": this.g,
                            "b": this.b
                        };
                    }
                } );
                Object.defineProperty( this, "hrgb", {
                    "get": function() {
                        return this.r.toString(16).lPad(2, '0') +
                               this.g.toString(16).lPad(2, '0') +
                               this.b.toString(16).lPad(2, '0');
                    }
                } );
                Object.defineProperty( this, "hrgba", {
                    "get": function() {
                        return this.r.toString(16).lPad(2, '0') +
                               this.g.toString(16).lPad(2, '0') +
                               this.b.toString(16).lPad(2, '0') +
                               ( ( 255 * this.a ) >> 0 ).toString( 16 );
                    }
                } );
                Object.defineProperty( this, "rgb", {
                    "get": function() {
                        return "rgb(" + this.r + ',' + this.g + ',' + this.b + ")";
                    }
                } );
                Object.defineProperty( this, "rgba", {
                    "get": function() {
                        return "rgba(" + this.r + ',' + this.g + ',' + this.b + ',' + this.a.toFixed(2) + ")";
                    }
                } );
                Object.defineProperty( this, "alpha", {
                    "get": function() {
                        return this.a;
                    }
                } );
                Object.defineProperty( this, "alphaPercent", {
                    "get": function() {
                        return ( this.a * 100 ) >> 0;
                    }
                } );
                
                this.setRed = function( r ) {
                    if ( r < 0 || r > 255 )
                        throw "Bad red value!";
                    this.r = r;
                    return this;
                }
                
                this.setGreen = function( g ) {
                    if ( g < 0 || g > 255 )
                        throw "Bad green value!";
                    this.g = g;
                    return this;
                }
                
                this.setBlue = function( b ) {
                    if ( b < 0 || b > 255 )
                        throw "Bad blue value!";
                    this.b = b;
                    return this;
                }
                
                this.setAlpha = function( a ) {
                    if ( a < 0 || a > 1 )
                        throw "Bad alpha value!";
                    this.a = a;
                    return this;
                }
                
                this.toString = function() {
                    return this.rgba;
                }
            } );
        }
    } );
    return c;
}

function CSSColor( CSSColorString ) {
    var lcColor;
    if ( !( lcColor = (CSSColorString || '' ).toString().toLowerCase().trim() ) ) {
        return null;
    } else {
        
        var matches;
        
        if ( typeof window.CSSDefs.colors[ lcColor ] != 'undefined' ) {
            lcColor = window.CSSDefs.colors[ lcColor ].toLowerCase();
        }
        
        switch (true) {
            case !!( matches = /^\#([\da-f]{6})$/i.exec( lcColor ) ):
                return CSSColorStruc( {
                    "r": parseInt( matches[1].substr( 0,2 ), 16 ),
                    "g": parseInt( matches[1].substr( 2,2 ), 16 ),
                    "b": parseInt( matches[1].substr( 4,2 ), 16 ),
                    "a": 1
                } );
                break;
            case !!( matches = /^\#([\da-f]{3})$/i.exec( lcColor ) ):
                return CSSColorStruc( {
                    "r": parseInt( matches[1].substr( 0, 1 ) + matches[1].substr(0,1), 16 ),
                    "g": parseInt( matches[1].substr( 1, 1 ) + matches[1].substr(1,1), 16 ),
                    "b": parseInt( matches[1].substr( 2, 1 ) + matches[1].substr(2,1), 16 ),
                    "a": 1
                } );
                break;
            case !!( matches = /^rgb\(([\s]+)?([\d]+)([\s]+)?,([\s]+)?([\d]+)([\s]+)?,([\s]+)?([\d]+)([\s]+)?\)$/i.exec( lcColor ) ):
                return CSSColorStruc( {
                    "r": parseInt( matches[2] ),
                    "g": parseInt( matches[5] ),
                    "b": parseInt( matches[8] ),
                    "a": 1
                } );
                break;
            case !!( matches = /^rgba\(([\s]+)?([\d]+)([\s]+)?,([\s]+)?([\d]+)([\s]+)?,([\s]+)?([\d]+)([\s]+)?,([\s]+)?((0?)\.[\d]+)([\s]+)?\)$/i.exec( lcColor ) ):
                return CSSColorStruc( {
                    "r": parseInt( matches[2] ),
                    "g": parseInt( matches[5] ),
                    "b": parseInt( matches[8] ),
                    "a": parseFloat( matches[11] )
                } );
                break;
            default:
                return null;
        }
    }
}

function CSSColorInput( value ) {
    return $('div', 'CSSColorInput').chain( function() {
        ( function( holder ) {
            return holder.appendChild( $('div', 'inner') ).chain( function() {
                this.tabIndex = 0;
                
                holder.addEventListener( "DOMFocusIn", function() {
                    holder.addClass( "focused" );
                    holder.onCustomEvent( "focus" );
                } );
                
                holder.addEventListener( "DOMFocusOut", function() {
                    holder.removeClass( "focused" );
                    holder.onCustomEvent( "blur" );
                });
                
                var unitClass = this.appendChild( new DropDown( [{
                    "id": "",
                    "name": "Is"
                } , {
                    "id": "inherit",
                    "name": "Inherit"
                } , {
                    "id": "transparent",
                    "name": "Transparent"
                } , {
                    "id": "empty",
                    "name": "Unspecified"
                }] ) ).addClass( 'class' );
                
                unitClass.onchange = function() {
                    holder.removeClass( 'color-inherit' ).removeClass( 'color-transparent' ).removeClass( 'color-empty' );
                    if ( unitClass.value )
                        holder.addClass( 'color-' + unitClass.value );
                    holder.onCustomEvent('change');
                };
                
                var color = this.appendChild( new ColorPicker('#000000') );
                color.title = "Color";
                
                color.addCustomEventListener('change', function() {
                    holder.onCustomEvent( 'change' );
                });
                
                var opacity = this.appendChild( new HSlider({
                    "value": 100
                }) );
                opacity.title = "Completely opaque";
                opacity.addCustomEventListener( 'change', function() {
                    holder.onCustomEvent( 'change' );
                    opacity.title = opacity.value == 0 
                        ? "Fully transparent"
                        : opacity.value == 100
                            ? "Completely opaque"
                            : opacity.value + "% transparent";
                    return true;
                } );
                setTimeout( function() {
                    opacity.paint();
                }, 0 );
                
                Object.defineProperty( holder, "value", {
                    "get": function() {
                        return unitClass.value
                            ? ( unitClass.value == 'empty' ? '' : unitClass.value )
                            : ( opacity.value < 100
                                ? CSSColor( color.value ).setAlpha( opacity.value / 100 ).rgba
                                : color.value
                            );
                    },
                    "set": function( s ) {
                        ( s = s + '' ).toLowerCase().trim();
                        var c;
                        switch ( true ) {
                            case s == '':
                                unitClass.value = 'empty';
                                break;
                            case s == 'inherit':
                                unitClass.value = 'inherit';
                                break;
                            case s == 'transparent':
                                unitClass.value = 'transparent';
                                break;
                            default:
                                c = CSSColor( s );
                                if ( c == null ) {
                                    unitClass.value = 'empty';
                                } else {
                                    unitClass.value = '';
                                    color.value = '#' + c.hrgb;
                                    opacity.value = c.alphaPercent;
                                }
                                break;
                        }
                        unitClass.onchange();
                    }
                } );
                
                var disabled = false,
                    readOnly = false;
                
                Object.defineProperty( holder, "disabled", {
                    "get": function() {
                        return disabled;
                    },
                    "set": function( b ) {
                        b = !!b;
                        disabled = b;
                        for ( var i=0, items = holder.querySelectorAll( 'select, .DOMColorPicker, .DomHSlider' ) || [], n = items.length; i<n; i++ )
                            items[i].disabled = disabled && readOnly;
                    }
                } );

                Object.defineProperty( holder, "readOnly", {
                    "get": function() {
                        return readOnly;
                    },
                    "set": function( b ) {
                        b = !!b;
                        readOnly = b;
                        for ( var i=0, items = holder.querySelectorAll( 'select, .DOMColorPicker, .DomHSlider' ) || [], n = items.length; i<n; i++ )
                            items[i].disabled = disabled && readOnly;
                    }
                } );
                
            } );
        } )( this );
    } ).chain( function(){
        this.value = ( value || '' );
    } );
}